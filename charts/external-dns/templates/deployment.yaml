apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-dns
  namespace: {{.Values.namespace}}
  labels: {{ include "kubee-manifest-labels" . | nindent 4}}
spec:
  replicas: 1
  selector:
    matchLabels: {{ include "kubee-pod-labels" . | nindent 6}}
  strategy:
    type: Recreate
  template:
    metadata:
      labels: {{ include "kubee-pod-labels" . | nindent 8}}
    spec:
      serviceAccountName: external-dns
      securityContext:
        fsGroup: 65534
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: external-dns
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            privileged: false
            readOnlyRootFilesystem: true
            runAsGroup: 65532
            runAsNonRoot: true
            runAsUser: 65532
          image: registry.k8s.io/external-dns/external-dns:v{{.Values.version}}
          imagePullPolicy: IfNotPresent
          env:
          {{- $cloudflare := and (gt (len .Values.cluster.dns.cloudflare.dns_zones 0))(ne .Values.cluster.dns.cloudflare.api_token '')(eq .Values.provider "") }}
          {{- if $cloudflare }}
            - name: CF_API_TOKEN
              valueFrom:
                secretKeyRef:
                  key: {{include "external-dns-cloudflare-secret-name"}}
                  name: api_token
          {{- end}}
          {{- range .Values.env }}
            - name: {{.name}}
              valueFrom:
                secretKeyRef:
                  key: {{include "external-dns-provider-secret-name"}}
                  name: {{.name}}
          {{- end }}
          args:
            - --log-level={{.Values.log.level}}
            - --log-format={{.Values.log.format}}
            - --interval={{.Values.interval}}
            {{- range .Values.sources }}
            - --source={{.}}
            {{- end }}
            {{- if .Values.traefik.enabled}}
            - --source=traefik-proxy # https://kubernetes-sigs.github.io/external-dns/latest/docs/sources/traefik-proxy/
            {{- end}}
            - --policy={{.Values.policy}}
            - --registry={{.Values.registry}}
            {{- if $cloudflare }}
            - --provider=cloudflare
            - --cloudflare-dns-records-per-page={{.Values.providers.cloudflare.dns_records_per_page}}
            {{- else }}
            - --provider={{ required "The provider name is required" .Values.provider}}
            {{- end}}
            {{- range .Values.server.managed_record_types }}
            - --managed-record-types={{.}}
            {{- end }}
            - --provider-cache-time={{.Values.cache_time}}
            {{- range .Values.domain_filter}}
            - --domain-filter={{.}}
            {{- end}}
            {{- if ne .Values.regex_domain_filter ""}}
            - --regexp={{.Values.regex_domain_filter}}
            {{- end }}
            {{- range .Values.args }}
            - {{.}}
            {{- end }}
          ports:
            - name: http
              protocol: TCP
              containerPort: 7979
          livenessProbe:
            failureThreshold: 2
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          readinessProbe:
            failureThreshold: 6
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
