

[//]: # (README.md generated by gotmpl. DO NOT EDIT.)

![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square) ![Version: 0.0.1](https://img.shields.io/badge/Version-0.0.1-informational?style=flat-square) ![AppVersion: 3.3.4](https://img.shields.io/badge/AppVersion-3.3.4-informational?style=flat-square)

# Kubee Postal Chart

This [Kubee Chart](https://github.com/EraldyHq/kubee/blob/main/docs/site/kubee-helmet-chart.md) installs [Postal](https://docs.postalserver.io/).

`Postal` is a `programmatic email server` known also as `Mail delivery platform`.

## Features

### Automatic Auth Oidc configuration

If [dex](https://github.com/EraldyHq/kubee/blob/main/charts/dex/README.md) is enabled and the dex postal secret (`.Values.dex.clients.postal.secret`) is not empty ,
`postal` is configured to log in via [dex](https://github.com/EraldyHq/kubee/blob/main/charts/dex/README.md).

### Kubee Charts Features

  These [kubee charts](https://github.com/EraldyHq/kubee/blob/main/docs/site/kubee-helmet-chart.md) add their features when `enabled`.

* [cert-manager](https://github.com/EraldyHq/kubee/blob/main/charts/cert-manager/README.md) adds [server certificates](https://cert-manager.io/docs/usage/certificate/) to the servers
* [dex](https://github.com/EraldyHq/kubee/blob/main/charts/dex/README.md)  adds Oidc Auth integration
* [prometheus](https://github.com/EraldyHq/kubee/blob/main/charts/prometheus/README.md) creates [metrics scraping jobs](https://prometheus.io/docs/concepts/jobs_instances/) and [alert rules](https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/)
* [traefik](https://github.com/EraldyHq/kubee/blob/main/charts/traefik/README.md) creates an [ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/) if hostnames are defined

## Installation Steps

### Cluster Values file Configuration

Set this values in your cluster values file.
```yaml
# mandatory
postal:
  enabled: true
  hostname: 'postal.example.com' # You should own this domain
  conf_secrets:
    dkim_signing_key: "${KUBEE_POSTAL_SIGNING_KEY}" # Generate the private key via `openssl genrsa -out path/to/signing.key 2048`
    db_password: '${KUBEE_POSTAL_MARIADB_PASSWORD}'
    rails_secret_key: '${KUBEE_POSTAL_RAILS_SECRET}'
    smtp_password: '${KUBEE_POSTAL_SMTP_PASSWORD}'
# Only if you want to log in via dex
dex:
  enabled: true
  clients:
    postal:
      secret: '${KUBEE_DEX_POSTAL_SECRET}'
```

> [!WARNING]
> The value of `KUBEE_POSTAL_SIGNING_KEY` should:
> * be double-quoted
> * have carriage returns replaced by the characters `\n`
> otherwise Yaml processing will replace the carriage returns by a space
>
> Example if you store your private key in [pass](https://github.com/EraldyHq/kubee/blob/main/docs/site/pass.md)
> ```bash
> export KUBEE_POSTAL_SIGNING_KEY
> KUBEE_POSTAL_SIGNING_KEY="$(pass 'kube/postal/signing-key' | awk 'BEGIN{RS="\n";ORS="\\n"}1')"
> ```

### Install

```bash
kubee --cluster cluster-name helmet play postal
```

### Create your first admin user

* Connect to one of the postal pods (ie `web`/`worker` or `smtp`. For example the `web pod`.
```bash
kubee -cluster clusterName app shell postal/web
```
* Enter the [postal make-user](https://docs.postalserver.io/getting-started/installation#initializing-the-database) command
```bash
postal make-user
```
* Enter the admin user information
```bash
Loading config from /config/postal.yml
Postal User Creator
Enter the information required to create a new Postal user.
This tool is usually only used to create your initial admin user.

E-Mail Address      : admin@example.com
First Name          : Admin
Last Name           : Admin
Initial Password    : ********* # Initial password is just the password. It's not asked for a password change

User has been created with e-mail address admin@example.com
```
* Go to https://postal.example.com and login

<img src="contrib/postal-login.jpg"  alt="Postal Login" width="300"/>

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| conf_secrets.db_password | string | `""` | The database password |
| conf_secrets.dkim_signing_key | string | `""` | Private key It should be in pem format (BEGIN/END PRIVATE KEY) The signing.key can be generated using the following command: `openssl genrsa -out path/to/signing.key 2048` |
| conf_secrets.rails_secret_key | string | `""` | Rail Secret key (for signing payload) |
| conf_secrets.smtp_password | string | `""` | The password to use when authentication to the SMTP server |
| enabled | bool | `false` | Boolean to indicate that this chart is or will be installed in the cluster |
| hostname | string | `""` | The hostname You should own the apex domain as you need to [add DNS record](https://docs.postalserver.io/getting-started/dns-configuration) |
| namespace | string | `"postal"` | The installation Namespace |
| version | string | `"3.3.4"` | The postal [docker version](https://github.com/postalserver/postal/pkgs/container/postal) (The release version Without the v) |
| conf_yaml | object | | [The Postal Configuration without secrets and host](https://github.com/postalserver/postal/blob/3.3.4/doc/config/yaml.yml) |
| conf_kube | object | | The configuration values for the kubernetes resources |

By default, all username are named `postal`. You can change them in the `conf_yaml` postal configuration section.

## Contrib / Dev

See [contrib](contrib/contrib.md)

