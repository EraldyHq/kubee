

[//]: # (README.md generated by gotmpl. DO NOT EDIT.)

![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square) ![Version: 0.0.1](https://img.shields.io/badge/Version-0.0.1-informational?style=flat-square) ![AppVersion: v1.17.1-v0.16.0](https://img.shields.io/badge/AppVersion-v1.17.1--v0.16.0-informational?style=flat-square)

# Kubee Cert-Manager Chart

## About
This `kubee chart` will install [cert-manager](https://cert-manager.io/) to manage certificates.

## Installation

### Enable and set your Email

* By default, `cert-manager` is disabled, it needs to be enabled.
* The email is used as account id by Letsencrypt and is mandatory.

In your helm values file, set the following values:

```yaml
cluster:
  auth:
    admin_user:
      email: 'foo@bar.com'
cert_manager:
  enabled: true
```

### Deploy

```bash
kubee --cluster clusterName helmet play cert-manager
```

### Change the default issuer

By default, the certificate are issued with `letsencrypt-staging` to not hit the
letsencrypt rate limit in case of misconfiguration.

The issued staging certificate are therefore [not valid](#why-my-certificates-are-not-valid).

Once you have controlled that you receive certificate
* from Letsencrypt
* and not the default Traefik certificate
you should change the default issuer value to `letsencrypt-prod`

Example: In your cluster values file.
```yaml
cert_manager:
  issuers:
    public:
      name: 'letsencrypt-prod'
```

## Features

It will create:
* [letsencrypt issuer](#letsencrypt-acme-issuers) to create external certificate (acme)
* [kubee-ca issuer](#kubee-internal-ca) to create internal service certificate (mtls)
* install the [cert-manager grafana dashboard and alerts](#dashboard-and-alerts)

### Letsencrypt Acme Issuers

2 `ClusterIssuers` are installed
* `letsencrypt-staging` for the `staging environment (test)`
* `letsencrypt-prod` for the `production environment`

The issuers solve the challenge:
* `http01` (default, ie an A or CNAME record should be present in the DNS Zone).
You can use the [external-dns](https://github.com/EraldyHq/kubee/blob/main/charts/external-dns/README.md) chart
to automate the creation.
* `dns01` with [DNS01 from cloudflare](#automatic-dns01-cloudflare-challenge-configuration)

The
* `letsencrypt-staging`. This is the Default used to:
  * ensure that the verification process is working properly before moving to production.
  * without hitting the [prod rate limits](https://letsencrypt.org/docs/rate-limits/)
* `letsencrypt-prod` issues valid signed certificate

### Challenge

### Kubee Internal CA

We use an internal CA to issue internal certificate
to:
* enable SSL communication internally
* issue certificate for auth service (database, oidc, ...)

### Dashboard and alerts

The [cert-manager mixin](https://monitoring.mixins.dev/cert-manager/) is installed
to create:
* the [grafana dashboard](https://monitoring.mixins.dev/cert-manager/#dashboards) if the [grafana chart ](../grafana/README.md) is enabled
* the [alerts](https://monitoring.mixins.dev/cert-manager/#alerts) if the [prometheus chart](../prometheus/README.md) is enabled

### Automatic DNS01 Cloudflare challenge configuration

By default, the `http01` challenge is executed.

When configured, you can:
* issue wildcard certificate
* use a dns name without creating A records.

Example after getting a [cloudflare api token](https://github.com/EraldyHq/kubee/blob/main/docs/site/cloudflare.md)

```yaml
cert_manager:
    issuers:
      public:
        dns01:
          cloudflare:
            api_token:
              value: '${KUBEE_CLOUDFLARE_API_TOKEN}'
            # The dns Zone that are managed by cloudflare
            dns_zones:
              - my-apex-domain.tld
              - another-apex-domain.tld
```

## Config

### Check the Root CA Bundle regularly

The root CA Bundle does not change regularly, but it changes.
You should check the actual version regularly.

See `How-to` at [Securely Maintaining a trust-manager Installation](https://cert-manager.io/docs/trust/trust-manager/#securely-maintaining-a-trust-manager-installation)

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| enabled | bool | `false` | Boolean to indicate that this chart is or will be installed in the cluster When disabled, the default ingress certificate specified on Traefik is used |
| issuers.kubee | object | `{"bundle_name":"kubee-ca-bundle","name":"kubee-ca"}` | The kubee issuer is used to create certificates for the internal service and pods (ie the local private domain cluster.local) |
| issuers.public | object | `{"dns01":{"cloudflare":{"api_token":{"key":"cloudflare-api-token","kind":"Secret","property":"","value":""},"dns_zones":[]}},"name":"letsencrypt-staging"}` | The public issuer name. The public issuer is used to create certificate for public access (ie public network / public domain name) Its name should be changed to `letsencrypt-prod` when the `letsencrypt-staging` is working and validated |
| namespace | string | `"cert-manager"` | The installation namespace |

For the whole set of values, see the [values file](values.yaml)
## Support

### Why my certificates are not valid

By default, this chart is set to work with the [Let's encrypt Staging environment](https://letsencrypt.org/docs/staging-environment/)
to not hit the rate limit.

The certificates are:
* not valid (not trusted)
* issued by:
    * Common Name (CN)	(STAGING) Counterfeit Cashew R10
    * Organization (O)	(STAGING) Let's Encrypt

### Why Only Cloudflare for DNS01?

The [DNS01 configuration](https://cert-manager.io/docs/configuration/acme/dns01/) is not
really standardized. If you need another one, opens an [%!s(uint8=105)](https://github.com/EraldyHq/kubee/issues)
.

## Contrib / Dev

See [contrib](contrib/contrib.md)

