

[//]: # (README.md generated by gotmpl. DO NOT EDIT.)

![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square) ![Version: 0.0.1](https://img.shields.io/badge/Version-0.0.1-informational?style=flat-square) ![AppVersion: v1.10.0](https://img.shields.io/badge/AppVersion-v1.10.0-informational?style=flat-square)

# Kubee PushGateway Chart

This [Kubee Chart](https://github.com/EraldyHq/kubee/blob/main/docs/site/kubee-helmet-chart.md) installs [pushgateway exporter](https://github.com/prometheus/pushgateway)
to monitor cron/ephemeral task.

You can push metrics to it that will be gathered by Prometheus.

## Example

* The metrics to push
```bash
RESULT=$(cat <<-'EOF'
# TYPE gitbackup_repo_count counter
# HELP gitbackup_repo_count the repos processed
gitbackup_repo_count {state="dumped", reason="changed"} 13
gitbackup_repo_count {state="skipped", reason="unchanged"} 139
gitbackup_repo_count {state="skipped", reason="empty"} 1
gitbackup_repo_count {state="skipped", reason="fork"} 50
gitbackup_repo_count {state="skipped", reason="pattern"} 1
EOF
```
* Jobs and instance label
```bash
JOB="git_hosting_backup"
INSTANCE="github-s3"
```
* The push
```bash
PUSHGATEWAY_API_URL=${PUSHGATEWAY_API_URL:-http://pushgateway.monitoring.svc.cluster.local:9091/metrics}
echo "$RESULT" | curl --fail --max-time 10 --retry 5 -s --data-binary @- "$PUSHGATEWAY_API_URL/job/$JOB/instance/$INSTANCE"
```
where the retry parameters may be:
* `--max-time 10`     (how long each retry will wait)
* `--retry 5`         (it will retry 5 times)
* `--retry-delay 0`   (an exponential backoff algorithm)
* `--retry-max-time`  (total time before it's considered failed)

## Features

### Persistent by Default

Pushgateway receives metrics from batch/ephemeral jobs that
run generally on a long interval.

Without persistence, the metrics are gone on a restart
and your alerts will fire.

To avoid this behavior, we persist by default, the metrics.

### Kubee Charts Features

  These [kubee charts](https://github.com/EraldyHq/kubee/blob/main/docs/site/kubee-helmet-chart.md) add their features when `enabled`.

* [cert-manager](https://github.com/EraldyHq/kubee/blob/main/charts/cert-manager/README.md) adds [server certificates](https://cert-manager.io/docs/usage/certificate/) to the servers
* [prometheus](https://github.com/EraldyHq/kubee/blob/main/charts/prometheus/README.md) creates [metrics scraping jobs](https://prometheus.io/docs/concepts/jobs_instances/) and [alert rules](https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/)
* [traefik](https://github.com/EraldyHq/kubee/blob/main/charts/traefik/README.md) creates an [ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/) if hostnames are defined

## Install

```bash
kubee --cluster cluster-name helmet play pushgateway
```

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| enabled | bool | `false` | Boolean to indicate that this chart is or will be installed in the cluster |
| hostname | string | `""` | The public hostname (Create an authenticated ingress if not empty) |
| namespace | string | `"monitoring"` | The installation namespace |
| persistence | object | `{"enabled":true,"interval":"5m","size":"50Mi","storage_class":"local-path"}` | Enable Metrics Persistence on a volume |
| version | string | `"v1.10.0"` | The [pushgateway version](https://hub.docker.com/r/prom/pushgateway) |

## Contrib / Dev

See [contrib](contrib/contrib.md)

