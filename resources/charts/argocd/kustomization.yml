# Installation
# Ref: https://github.com/argoproj/argoproj-deployments/blob/master/argocd/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Custom Namespace
# https://argo-cd.readthedocs.io/en/stable/operator-manual/installation/#installing-argo-cd-in-a-custom-namespace
namespace: ${KUBE_X_NAMESPACE}

patches:
  # Patch needed to apply the server transport via annotation to disable tls validation from Traefik
  - path: templates/patches/argocd-cmd-params-cm.yml
  - path: templates/patches/argocd-notifications-cm.yml
  - path: templates/patches/argocd-notifications-secret-patch.yml
  - path: templates/patches/argocd-secret-patch.yml
  - path: templates/patches/argocd-svc-no-tls-patch.yml
  # CustomNamespace patch: https://argo-cd.readthedocs.io/en/stable/operator-manual/installation/#installing-argo-cd-in-a-custom-namespace
  - patch: |-
      - op: replace
        path: /subjects/0/namespace
        value: ${KUBE_X_NAMESPACE}
    target:
      kind: ClusterRoleBinding

# Note: External Secret are resources while secret already present in install.yaml are patches
resources:
  - https://raw.githubusercontent.com/argoproj/argo-cd/v2.11.7/manifests/install.yaml
  - templates/resources/argocd-ingress.yaml
  - templates/resources/argocd-namespace.yml
  - templates/resources/argocd-notifications-secret-external.yml
  - templates/resources/argocd-prometheus-alert-rule.yml
  - templates/resources/argocd-secret-external.yml
  - templates/resources/argocd-secret-repo.yml
  - templates/resources/argocd-service-monitor-metrics.yml
  - templates/resources/argocd-svc-no-tls-transport.yml
