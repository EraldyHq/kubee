#!/bin/bash
# A post renderer to integrate kustomize and jsonnet
# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-error.sh"
error::set_trap
set -TCEeuo pipefail
# shellcheck source=../../bash-lib/lib/bashlib-echo.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-echo.sh"
# shellcheck source=../../bash-lib/lib/bashlib-doc.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-doc.sh"
# shellcheck source=../../bash-lib/lib/bashlib-bash.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-bash.sh"
# shellcheck source=../../bash-lib/lib/bashlib-command.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-command.sh"
# shellcheck source=kube-x-lib.sh
source kube-x-lib.sh

KUBE_X_CHART_DIRECTORY="${1:-}"

if [[ "$KUBE_X_CHART_DIRECTORY" =~ "synopsis"|"help" ]]; then
  cat <<EOF
A post renderer to integrate \`kustomize\` and \`jsonnet\`
\`\`\`bash
$(basename "$0") appDirectory valuesPath KUBE_X_NAMESPACE
\`\`\`

where:

* \`KUBE_X_CHART_DIRECTORY\` is the directory of the app to install
* \`KUBE_X_VALUES_FILE\` is the path to the values file
* \`KUBE_X_NAMESPACE\` is the installation namespace

Note: the Helm templates should be passed via stdin
EOF
  exit 0
fi

if [ ! -d "$KUBE_X_CHART_DIRECTORY" ]; then
  echo::err "Internal Error: the first argument KUBE_X_CHART_DIRECTORY ($KUBE_X_CHART_DIRECTORY) is not a valid directory"
  exit 1
fi

# Values path is already generated at this point
# that's why we pass it and not regenerate it
KUBE_X_VALUES_FILE="${2:-}"
if [ ! -f "$KUBE_X_VALUES_FILE" ]; then
  echo::err "Internal Error: the second argument values path ($KUBE_X_VALUES_FILE) is not a valid file"
  exit 1
fi

KUBE_X_NAMESPACE="${3:-}"
if [ "$KUBE_X_NAMESPACE" == "" ]; then
  echo::err "Internal Error: the third argument namespace should not be empty"
  exit 1
fi


# The whole script run in the app directory
pushd "$KUBE_X_CHART_DIRECTORY" > /dev/null
bash::trap 'popd >/dev/null' EXIT # EXIT execute also on error

# Kustomize
# Example:
# https://github.com/thomastaylor312/advanced-helm-demos/tree/master/post-render
KUSTOMIZATION_FILE=$(realpath "$KUBE_X_CHART_DIRECTORY/kustomization.yml")
KUSTOMIZATION_MODE=0
if [ -f "$KUSTOMIZATION_FILE" ]; then
  KUSTOMIZATION_MODE=1
else
  echo::info "No kustomization file ($KUSTOMIZATION_FILE)"
fi

# Grab the manifests passed by Helm
HELM_MANIFEST=$(cat)
# In kustomization mode, the templates are re-created individually
# because we don't known which one is a resource and which one is a patch
# The kustomization file is the driver
if [ "$KUSTOMIZATION_MODE" -eq 1 ]; then
  HELM_MANIFEST=""
fi

##################
# JsonNet
##################
# Processing any JsonNet template if any
JSONNET_DIR="jsonnet"
if [ -d "$JSONNET_DIR" ]; then

  echo::info "Jsonnet processing"

  # Update the dependencies (vendor directory)
  JPATH="vendor"
  JSONNET_FILE="jsonnetfile.json"
  if [ ! -d "$JPATH" ] && [ -f "$JSONNET_FILE" ]; then
    jb update
  fi


  for JSONNET_FILE in jsonnet/*.jsonnet; do

    echo::info "Processing $JSONNET_FILE"

    # Run
    MIXIN_MANIFEST=$(
      # --string: string as output
      jsonnet \
        --jpath "$JPATH" \
        --string \
        --ext-code "values=std.parseYaml(importstr \"$KUBE_X_VALUES_FILE\")" \
        --exec "std.manifestYamlDoc((import \"$JSONNET_FILE\"))"
    )

    # Add the jsonnet manifest
    HELM_MANIFEST=$(cat <<EOF
$HELM_MANIFEST
---
# Source: $JSONNET_FILE
$MIXIN_MANIFEST
EOF
)

  done

else
  echo::info "No Jsonnet directory found"
fi

# Kustomize
# Example:
# https://github.com/thomastaylor312/advanced-helm-demos/tree/master/post-render
if [ "$KUSTOMIZATION_MODE" -eq 1 ]; then
  echo::info "Kustomization processing (File: $KUSTOMIZATION_FILE)"

  # The root run dir is fix so that the content is deleted at every run
  # To be able to debug, the content is not deleted on error
  KUSTOMIZE_ROOT_TEMP_DIR="$(dirname "$(mktemp -u)")/kube-x"
  rm -rf "$KUSTOMIZE_ROOT_TEMP_DIR"

  # Package Run/Temp Dir
  # The name of the directory is not random
  # It follows the usage of the output command `helm template --output-dir=$KUSTOMIZE_ROOT_TEMP_DIR`
  # The templates are then stored at $KUSTOMIZE_ROOT_TEMP_DIR/CHART_NAME/templates/...yml
  CHART_NAME=$(yq '.name' "$KUBE_X_CHART_DIRECTORY/Chart.yaml")
  KUSTOMIZE_PACKAGE_TEMP_DIR="$KUSTOMIZE_ROOT_TEMP_DIR/$CHART_NAME"
  mkdir -p "$KUSTOMIZE_PACKAGE_TEMP_DIR"

  # Output of Kustomization
  export KUBE_X_NAMESPACE
  # Variable Substitution: Check the variables
  if ! UNDEFINED_VARS=$(template::check_vars -f "$KUSTOMIZATION_FILE"); then
       # Should exit because of the strict mode
       # but it was not working
       echo::err "Values variables missing: ${UNDEFINED_VARS[*]} in file $KUSTOMIZATION_FILE"
       exit 1
  fi
  envsubst < "$KUSTOMIZATION_FILE" >| "${KUSTOMIZE_PACKAGE_TEMP_DIR}/kustomization.yml"

  # Output templates
  # helm template --output-dir /tmp
  # will output all templates one by one at: $KUSTOMIZE_ROOT_TEMP_DIR/chart-name/templates/argocd-service-monitor-metrics.yml
  command::echo_eval "helm template --output-dir $KUSTOMIZE_ROOT_TEMP_DIR -f $KUBE_X_VALUES_FILE $KUBE_X_CHART_DIRECTORY"

  # The argument must be:
  # * a file system path
  # * or git repository path (git URL with path)
  # containing 'kustomization.yaml'
  # equivalent to: kustomize build .
  # https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/helmcharts/
  # https://github.com/mgoltzsche/khelm
  # Flag --reorder has been deprecated, use the new 'sortOptions' field in kustomization.yaml instead.
  if KUSTOMIZE_MANIFEST=$(cd "$KUSTOMIZE_PACKAGE_TEMP_DIR" && kubectl kustomize --reorder=none .); then
    # we delete the directory only on success
    # most errors comes from the generation,
    if [ "$BASHLIB_ECHO_LEVEL" != "$BASHLIB_ECHO_DEBUG_LEVEL" ]; then
      rm -rf "$KUSTOMIZE_PACKAGE_TEMP_DIR"
    else
      echo::err "The command 'kubectl kustomize .' was executed with the $KUSTOMIZE_PACKAGE_TEMP_DIR working directory"
    fi
    # Add the kustomize manifest to the Jsonnet manifest if any
    HELM_MANIFEST=$(cat <<EOF
$HELM_MANIFEST
---
$KUSTOMIZE_MANIFEST
EOF
)
  else
    echo::err "An error occurred during the kustomization"
    echo::err "The command 'kubectl kustomize .' failed with the $KUSTOMIZE_PACKAGE_TEMP_DIR working directory"
    exit 1
  fi
fi

# Output
echo "$HELM_MANIFEST"
