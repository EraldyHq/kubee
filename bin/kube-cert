#!/bin/bash
# @name kube-cert
# @brief Return the kubeconfig cert in plain text
# @description
#     Return the kubeconfig cert in plain text
#

set -Eeuo pipefail
source bashlib-echo.sh
source bashlib-error.sh
source bashlib-path.sh
source bashlib-command.sh
source bashlib-crypto.sh
error::set_trap

HELP=${1:-}
if [[ $HELP =~ -h|--help|help ]]; then
  echo "Usage:"
  echo ''
  echo 'Return the kubeconfig certs in plain text'
  echo ''
  echo '```bash'
  # shellcheck disable=SC2005
  echo "$(basename "$0")"
  echo '```'
  exit
fi



# base 64 encoded, X.509v3 certificate
TEMP_DIR=$(mktemp --directory)
TEMP_PEM=$TEMP_DIR/temp.pem
grep 'client-certificate-data' "$HOME"/.kube/config | awk '{print $2}' | base64 -d > "$TEMP_PEM"
# openssl storeutl permits to read a bundle does not take stdin as input
crypto::certificate_to_text "$TEMP_PEM"
rm -rf "$TEMP_DIR"

