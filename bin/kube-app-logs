#!/bin/bash
#
# @name kube-app-logs
# @brief Return the log of pods of an app (workload)
# @description
#     Return the log of pods of an app (workload)
#

set -Eeuo pipefail
source bashlib-echo.sh
source bashlib-error.sh
error::set_trap

######################
# Main
######################

usage(){
  echo "Usage:"
  echo ""
  echo "Return the logs of pods via an app name"
  echo ""
  echo '```bash'
  # shellcheck disable=SC2005
  echo "$(basename "$0") <app name>"
  echo '```'
  # shellcheck disable=SC2016
  echo 'where `app name` is used in the label `app.kubernetes.io/name=<app name>`'

}

# Check if the app name is provided
if [ -z "$1" ]; then
    usage
    exit 1
fi

APP_NAME=$1

# Help ?
if [[ $APP_NAME =~ -h|help ]]; then
  usage
  exit
fi

#echo::info Getting Pod Name and Namespace for app "$APP_NAME"
read -r POD_NAME POD_NAMESPACE <<< "$(kube::get_resource_by_app_name "$APP_NAME" pod)"

APP_LABEL=$(kube::get_app_label "$APP_NAME")
if [ -z "$POD_NAME" ]; then
    echo::err "Error: No pod found with the label $APP_LABEL"
    exit 1
fi

# https://kubernetes.io/docs/reference/kubectl/generated/kubectl_logs/
echo::info "Getting logs for pods"
COMMAND="kubectl logs -f -l $APP_LABEL -n $POD_NAMESPACE --all-containers=true"
echo::info "Executing: $COMMAND"
eval "$COMMAND"

