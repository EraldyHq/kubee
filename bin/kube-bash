#!/bin/bash
# @name kube-bash
# @brief Start bash in a pod via bash
# @description
#     Connect with a shell (bash by default) to a pod by app name
#
#

set -Eeuo pipefail
source bashlib-echo.sh
source bashlib-error.sh
error::set_trap
source bashlib-kube.sh


usage(){
  echo "Usage:"
  echo ""
  echo '```bash'
  echo "$(basename "$0") <app name>"
  echo '```'
  echo ""
  # shellcheck disable=SC2016
  echo 'Note: The label `app.kubernetes.io/name=<app name>` is used to select the target pod'
}

######################
# Main
######################

# Check if the app name is provided
if [ -z "$1" ]; then
    usage
    exit 1
fi

APP_NAME=$1

if [[ "$APP_NAME" =~ -h|help ]]; then
  usage
  exit
fi

POD_SHELL=${2:-}
if [ "$POD_SHELL" == "" ]; then
  if [ "$APP_NAME" == "prometheus" ]; then
    POD_SHELL=/bin/sh
    else
    POD_SHELL=/bin/bash
  fi
fi

if [ "$APP_NAME" == "busybox" ]; then
    kubectl run -it busybox-pod --image=busybox:1.36.1 --restart=Never --rm -n default
    exit 0
fi

echo::info "Getting Pod Name and Namespace for app $APP_NAME"

read -r POD_NAME POD_NAMESPACE <<< "$(kube::get_pod "$APP_NAME")"

echo::info "Pod Name: $POD_NAME"
echo::info "Pod Namespace: $POD_NAMESPACE"
kubectl exec -it "$POD_NAME" -n "$POD_NAMESPACE" -- "$POD_SHELL"
